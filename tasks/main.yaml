---
- name: Check that required passed variables are defined
  ansible.builtin.include_tasks:
    file: assert_vars.yaml
  tags:
    - nftables_setup
    - nftables_update
    - nftables_install

- name: Include rules from rules file
  ansible.builtin.include_vars:
    file: vars/rules.yaml
  when: not nft_rules
  tags:
    - nftables_setup
    - nftables_update
    - nftables_install

- name: Include variables from variables file
  ansible.builtin.include_vars:
    file: vars/variables.yaml
  when: not nft_variables
  tags:
    - nftables_setup
    - nftables_update
    - nftables_install

- name: Assert rules are properly defined
  ansible.builtin.include_tasks:
    file: assert_rules.yaml
    apply:
      tags:
        - nftables_setup
        - nftables_update
        - nftables_install

- name: Install nftables and requirements for this role
  ansible.builtin.package:
    name:
      - nftables
      - python3-nftables
      - pip
    state: present
  become: true
  tags:
    - nftables_install

- name: Ensure firewall directory exists
  ansible.builtin.file:
    path: "{{ nftables_dir }}"
    state: directory
    mode: u=rwx,g=rx,o=rx
  become: true
  tags:
    - nftables_setup

- name: List nft tables
  ansible.builtin.command: nft list tables
  become: true
  check_mode: false
  changed_when: false
  register: current_nft_tables
  tags:
    - nftables_setup
    - nftables_update

- name: Grab current nfttable names from output
  ansible.builtin.set_fact:
    nft_table_names: "{{ current_nft_tables.stdout_lines | map('regex_replace', '^table
      ', '') }}"
  tags:
    - nftables_setup
    - nftables_update

- name: Create tables that do not exist in nft (to avoid issues)
  ansible.builtin.command: "nft add table {{ table }}"
  become: true
  when: not table in nft_table_names
  loop: "{{ nftables.keys() }}"
  loop_control:
    loop_var: table
  tags:
    - nftables_setup

- name: Create dynamic tables that do not exist in nft (to avoid issues)
  ansible.builtin.command: "nft add table {{ table }}"
  become: true
  when: not table in nft_table_names
  loop: "{{ dynamic_nftables.keys() | list + ['inet blocklist'] }}"
  loop_control:
    loop_var: table
  tags:
    - nftables_setup

- name: Copy variable definitions nft file
  ansible.builtin.template:
    src: defines.nft.j2
    dest: "{{ nftables_dir }}/defines.nft"
    validate: /usr/sbin/nft -c -f %s
    mode: u=rw,g=r,o=
  become: true
  tags:
    - nftables_update
  notify: reload ruleset

- name: Copy sets definitions nft file
  ansible.builtin.template:
    src: filter_sets.nft.j2
    dest: "{{ nftables_dir }}/filter_sets.nft"
    mode: u=rw,g=r,o=
    # validation will crash because
    # this file is meant to be included in firewall.nft
  become: true
  tags:
    - nftables_update

- name: Check which dynamic table files do not exist yet and create them if necessary
  ansible.builtin.include_tasks:
    file: create_dynamic_tables.yaml
    apply:
      tags:
        - nftables_update
  loop: "{{ dynamic_nftables.keys() }}"
  loop_control:
    loop_var: table
  tags:
    - nftables_update
  when: dynamic_nftables

- name: Create blocklist as empty table if it does not exist in nft
  ansible.builtin.template:
    src: blocklist.nft.j2
    dest: "{{ nftables_dir }}/blocklist.nft"
    mode: u=rw,g=r,o=
  # crashes on validation due to dependencies,
  # gets validated as a whole when global file is pushed
  # validate: /usr/sbin/nft -c -f %s
  become: true
  # when table just got created
  when: not "inet blocklist" in nft_table_names
  tags:
    - nftables_setup
  notify: reload ruleset

- name: Copy all template nft files
  ansible.builtin.template:
    src: "table.nft.j2"
    dest: "{{ nftables_dir }}/{{ table | strip_family }}.nft"
    mode: u=rw,g=r,o=
    # crashes on validation due to dependencies,
    # gets validated as a whole when global file is pushed
    # validate: /usr/sbin/nft -c -f %s
  become: true
  loop: "{{ nftables.keys() }}"
  loop_control:
    loop_var: table
  tags:
    - nftables_update
  notify: reload ruleset

- name: Copy global nftable config file
  ansible.builtin.template:
    src: nftables.nft.j2
    dest: "{{ nftables_dir }}/nftables.nft"
    validate: /usr/sbin/nft -c -f %s
    mode: u=rw,g=r,o=
  become: true
  tags:
    - nftables_update
  notify: reload ruleset

- name: Move firewall reloading script to lib
  ansible.builtin.template:
    src: reload_firewall.sh.j2
    dest: "{{ nft_script_folder }}/reload_firewall.sh"
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  become: true
  tags:
    - nftables_setup

- name: Create nftables systemd directory
  ansible.builtin.file:
    dest: /etc/systemd/system/nftables.service.d
    state: directory
    owner: root
    group: root
    mode: u=rwx,g=rx,o=rx
  become: true
  tags:
    - nftables_setup

- name: Edit nftables service to point to our main nftables file
  ansible.builtin.template:
    src: nftables.service.j2
    dest: /etc/systemd/system/nftables.service.d/override.conf
    owner: root
    group: root
    mode: u=rw,g=r,o=r
  when: not ansible_check_mode
  become: true
  tags:
    - nftables_setup

- name: Create abuseip_db based blocklist
  ansible.builtin.include_tasks:
    file: abuseip_blocklist.yaml
    apply:
      tags:
        - nftables_setup
  when: abuseip_api_key

- name: Uninstall iptables if present
  ansible.builtin.package:
    name: iptables
    state: absent
  become: true
  when: uninstall_iptables
  tags:
    - nftables_install
